{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Karigar mapping: support any-sheet Excel tables + clearer UX + upload summary",
  "requirements": [
    {
      "id": "REQ-64",
      "summary": "Extend karigar mapping Excel parsing to support single-sheet tabular workbooks with any sheet name, while preserving existing 1/3/2 sheet priority behavior and improving rejection diagnostics.",
      "acceptanceCriteria": [
        "Given an uploaded .xlsx/.xls mapping workbook with a single sheet (e.g., \"Sheet1\") that contains headers like \"Design\", \"NAME\", and \"KARIGAR\", parsing succeeds and produces non-zero mapping entries.",
        "Given an uploaded workbook that contains sheets named \"1\", \"2\", and/or \"3\", the parser continues to prioritize sheets in order: 1, then 3, then 2 (current behavior).",
        "If a workbook contains both the traditional sheets and other sheets, the traditional sheet priority remains unchanged.",
        "If no sheets contain a detectable Design + Karigar header pair, the parser fails with a clear English error that lists which sheets were checked and why they were rejected (e.g., missing required columns)."
      ],
      "file_operations": [
        {
          "path": "frontend/src/features/daily-orders/excel/parseKarigarMapping.ts",
          "operation": "modify",
          "description": "Update Excel workbook sheet selection logic to: (1) keep current priority when sheets \"1\"/\"3\"/\"2\" exist (check in order 1→3→2 only), and (2) when none of those exist, scan all workbook sheets and parse any sheet that contains a detectable Design (Design/Product Code) + Karigar header pair. When parsing fails, throw a clear English error that lists each checked sheet and the rejection reason (e.g., empty sheet, missing Design column, missing Karigar column, or no valid rows after parsing). Ensure single-sheet tabular workbooks like the user’s example can yield non-zero entries."
        },
        {
          "path": "frontend/src/features/daily-orders/excel/parseKarigarMapping.ts",
          "operation": "modify",
          "description": "Refactor header detection to produce explicit per-sheet diagnostics (e.g., detected header row sample and which required columns were missing) so the UI can display actionable errors without stack traces. Keep existing normalization behavior unless required for the new sheet-selection support."
        }
      ]
    },
    {
      "id": "REQ-65",
      "summary": "Improve Karigar Mapping upload tab copy and errors to explicitly support any-sheet tabular Excel mapping format and clearly explain mapping failures.",
      "acceptanceCriteria": [
        "Karigar Mapping tab’s “File Format Requirements” text states that the mapping can be any sheet name, as long as the file contains columns for Design Code (Design/Product Code), Karigar, and optional Name/Generic Name.",
        "When a user attempts to upload an unsupported format (e.g., .jpeg screenshot), the UI shows an English error explaining that only Excel (.xlsx/.xls) and PDF are supported and that screenshots/images cannot be parsed.",
        "When parsing fails due to missing required columns, the UI shows an English error that states which required columns were not found (Design and Karigar) and suggests using headers like “Design” and “Karigar”."
      ],
      "file_operations": [
        {
          "path": "frontend/src/features/karigar-mapping/KarigarMappingTab.tsx",
          "operation": "modify",
          "description": "Update the “File Format Requirements” copy to explicitly state that the Excel workbook can use any sheet name, as long as it contains required columns for Design Code (Design/Product Code) and Karigar, with optional Name/Generic Name. Keep mention of sheet priority only for the traditional \"1\"/\"3\"/\"2\" case."
        },
        {
          "path": "frontend/src/features/karigar-mapping/KarigarMappingTab.tsx",
          "operation": "modify",
          "description": "Add a pre-parse file validation guard so if the user selects an unsupported file type (e.g., .jpeg/.png screenshot/image), show an English error explaining only Excel (.xlsx/.xls) and PDF are supported and that screenshots/images cannot be parsed. Ensure errors remain user-friendly (no stack traces)."
        },
        {
          "path": "frontend/src/utils/userFacingError.ts",
          "operation": "modify",
          "description": "Ensure mapping parser errors are surfaced as-is when they are already clear English messages (including new per-sheet rejection lists), while still avoiding exposing raw stack traces or internal exception formats."
        }
      ]
    },
    {
      "id": "REQ-66",
      "summary": "Show an English post-upload (and loaded) summary of the parsed karigar mapping: total entries and sheet name(s) used.",
      "acceptanceCriteria": [
        "After a successful upload/save, the Karigar Mapping tab displays a summary including: total mapping entries parsed and the sheet name(s) used.",
        "The summary is shown only when a mapping is currently loaded (either immediately after upload or after fetching existing mapping).",
        "All summary text is in English and does not expose raw stack traces or internal exceptions."
      ],
      "file_operations": [
        {
          "path": "frontend/src/features/karigar-mapping/useKarigarMappingSummary.ts",
          "operation": "create",
          "description": "Create a small helper/hook that, given the currently loaded mapping blob, decodes it (via existing karigarMappingBlobCodec) and computes a user-facing summary: total parsed entries and sheet name(s) present/used. Ensure it returns safe English error strings on decode failure (no raw stack traces)."
        },
        {
          "path": "frontend/src/features/karigar-mapping/KarigarMappingTab.tsx",
          "operation": "modify",
          "description": "After a successful upload/save, compute and store an in-memory summary (total entries + sheet names from the freshly parsed workbook) and render it in the tab. Also, when an existing mapping blob is fetched, use the new summary helper/hook to display the same summary only when a mapping is loaded. Keep all summary text in English and avoid exposing internal exception details."
        }
      ]
    }
  ]
}