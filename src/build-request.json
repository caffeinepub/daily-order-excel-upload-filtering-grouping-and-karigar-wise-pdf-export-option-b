{
  "kind": "build_request",
  "title": "Fix karigar mapping matching by scanning all sheets and applying consistent design-code normalization",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Update karigar mapping Excel parsing to support the user’s Excel-style mapping table on any sheet name (Design + NAME + KARIGAR), even when the workbook also contains sheets named \"1\", \"2\", or \"3\". Priority sheets (1 → 3 → 2) should still be parsed first, but the parser must also scan remaining sheets and include any sheet that contains the required columns.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Pls start fixing the mapping issue from what you’ve learned from the screenshot I shared today."
        ]
      },
      "acceptanceCriteria": [
        "Uploading a mapping workbook where the mapping table exists on a non-priority sheet name (e.g., \"Sheet1\") successfully loads mappings.",
        "Uploading a mapping workbook that contains sheets named \"1\"/\"2\"/\"3\" but has the mapping table on a different sheet still loads mappings from that other sheet.",
        "When multiple sheets contain valid mappings for the same Design code, entries from sheets are applied in priority order: \"1\" then \"3\" then \"2\" then the remaining sheets in workbook order (or a deterministic documented order).",
        "The parser continues to treat columns case-insensitively and via header aliases, and continues to support optional NAME (generic name) and required KARIGAR."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Fix mapping lookup application so that Order List enrichment uses mappings from any parsed sheet name, not only sheets \"1\", \"3\", and \"2\". Preserve the existing priority behavior for sheets \"1\", \"3\", \"2\" but fall back to all other sheets when present, ensuring orders enrich correctly when the mapping workbook uses arbitrary sheet names.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Pls start fixing the mapping issue from what you’ve learned from the screenshot I shared today."
        ]
      },
      "acceptanceCriteria": [
        "If a mapping blob contains only non-priority sheet names, Order List still enriches orders (Generic Name and Karigar) when Design codes match.",
        "If a mapping blob contains both priority and non-priority sheets, Order List enrichment prefers matches from priority sheets but still matches against non-priority sheets when a Design is not present in priority sheets.",
        "The Order List “Mapping Status” section no longer shows “mapping loaded but no orders match” for the user’s provided scenario where the mapping table contains matching design codes (assuming normalization rules make them equivalent)."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Ensure design-code matching uses a single shared canonical normalization for both mapping ingestion and order enrichment (using the existing normalizeDesignCode behavior) and add/keep clear diagnostics to help detect remaining mismatches (e.g., show sample normalized keys from orders and mapping when there are 0 matches).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Pls start fixing the mapping issue from what you’ve learned from the screenshot I shared today."
        ]
      },
      "acceptanceCriteria": [
        "Order designs and mapping designs are both normalized using the same normalizeDesignCode function before lookup.",
        "When there are 0 matches but a mapping is loaded, the UI shows debug samples of normalized order keys and normalized mapping keys (no crash).",
        "Re-uploading a mapping workbook after this change immediately affects matching without requiring backend schema changes or manual data migration (existing stored blobs remain decodable and usable)."
      ]
    }
  ],
  "constraints": [
    "Do not edit files under frontend/src/components/ui (compose them instead).",
    "Do not edit immutable paths: frontend/src/hooks/useInternetIdentity.ts, frontend/src/hooks/useInternetIdentity.tsx, frontend/src/hooks/useActor.ts, frontend/src/main.tsx, frontend/src/components/ui.",
    "Backend must remain single-actor (all Motoko logic in backend/main.mo)."
  ],
  "nonGoals": [
    "Changing backend storage schema for mappings (the mapping workbook remains stored as an ExternalBlob).",
    "Adding new authentication providers (only Internet Identity if needed).",
    "Building OCR/screenshot-to-Excel parsing (images/screenshots remain unsupported as upload inputs)."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}